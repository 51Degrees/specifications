TODO - this content has been copied from the old spec document. Needs review and refactor.

# Share usage element 

Users of 51Degrees products have the option for us to collect their usage data in the form of web requests. This data is extremely important to us and feeds into a range of other processes. Data that is processed by the Pipeline can be shared with 51Degrees via the share usage element. Share usage is enabled by default when using the specific pipeline builders (e.g. DeviceDetectionPipelineBuilder) but can be disabled.   

The pipeline engines package must include a specific flow element that will take the relevant data from the Flow Data and transform it into xml format ready for transmission to the 51Degrees usage web service.  

XML should be collected in memory until 50 instances have been added or the pipeline is closed/disposed. At this point, a background thread should be started (ideally using a thread pool if the language supports it) where processing and sending the message can continue without impacting the performance of the pipeline request. 

The XML fragments must be combined into a single document under a <Devices> root element and declaration added to make it a valid XML document. The XML is then compressed using gzip and sent via HTTP POST with a content type of “text/xml” to the service at https://devices.51degrees.com/new.ashx  

The XML format is: 

```xml
<Device>
<SessionId>SESSION_ID</SessionId> 
<Sequence>SEQUENCE</Sequence> 
<DateSent>DATE_SENT</DateSent> 
<Version>API_VERSION</Version> 
<Product>API_NAME</Product>  
<FlowElement>ELEMENT1</FlowElement> 
<FlowElement>ELEMENT2</FlowElement>	 
<Language>LANG</Language> 
<LanguageVersion>LANG_VERSION</LanguageVersion> 
<ClientIP>IP_ADDRESS</ClientIP> 
<ServerIP>IP_ADDRESS</ServerIP> 
<Platform>PLATFORM PLATFORM_VER SERVICE_PACK</Platform> 
EVIDENCE: 
<PREFIX Name=”FIELD”><![CDATA[VALUE]]></PREFIX> 
FOR EXAMPLE: 
<Header Name=”User-Agent”><![CDATA[USER_AGENT]]></Header> 
<Header Name=”Host”><![CDATA[HOST]]></Header> 
<Cookie Name=”51D_ProfileIds”><![CDATA[50728]]></Cookie> 
<Cookie Name=”51D_ScreenPixelsHeight”><![CDATA[1080]]></Cookie> 
</Device> 
```

- **SessionId** – A GUID generated by the Share Usage element used to identify a set of evidence originating from the same source where multiple requests are initiated to resolve the json payload for updated evidence, e.g. client-side overrides or geo location. 
- **Sequence** – An integer paired with the SessionId which is incremented each time the sequence value is seen in evidence to identify the number of requests in a session. 
- **DateSent** - The date that the xml was constructed in the following format: yyyy-mm-ddThh:nn:ss 
- **Version** - The version of the pipeline that is being used to generate the xml. E.g. “4.0” 
- **Product** - The name of the product that is generating the xml. E.g. “Robin” 
- **FlowElement** – An xml element exists for each FlowElement in the pipeline. The text contains the fully qualified name of the FlowElement.  
- **Language** - The name of the language/framework within which the pipeline is running. 
- **LanguageVersion** - The version number of the language/framework within which the pipeline is running. 
- **ClientIP** - IP address of the client that sent the request to this server. 
- **ServerIP** - IP address of the server where the xml is being generated. 
- **Platform** - The platform name, version and service pack. 
- **Evidence** – The evidence that is shared will be determined by its evidence key filter as defined below. 

The EvidenceKeyFilter for share usage is a specific implementation that should return false for any key where: 

- Prefix = ‘header’ and field is in a user-configurable blacklist (by default, this blacklist must include the ‘cookies’ header). 
- Prefix = ‘cookie’ and field does not start with 51D_ 
- Prefix = ‘query’ and field is not in a user-configurable whitelist of query string parameters that should be shared.

Anything else should return true. (i.e. share usage does want it to be included in the evidence) 

The share usage element should NOT be referenced in the Pipeline Builder. Instead, derived pipeline builders for the various engines (e.g. a ‘device detection pipeline builder’) should, by default, include the share usage element when they build the pipeline. The user should be able to configure the builder not to include the share usage element if they wish. 

The share usage element should have a property ‘SharePercentage’ which defines what proportion of requests are added to the queue for sharing. By default this is 1 (which means all requests). As an example, setting SharePercentage to 0.01 would only add 1 in every 100 requests to the queue for sharing. This means that usage sharing can be enabled in high volume environments like ad tech without affecting performance as much as it otherwise would. 

# Session tracking 

Share usage will generate its own session ID for tracking a series of requests where a new series begins for the initial request. The series continues until any subsequent requests with updated evidence have been fulfilled by the pipeline. The SessionID will be used by 51Degrees data processing to identify a series of requests so that they can be merged into one record. Ideally, share usage would only send data once for each user session on a website but this would mean caching all session IDs that have been encountered. 

The Session ID is persisted by sending it to the client, the client then sends this Session ID along with each request in the form of a cookie or header depending on the implementation. In the cloud client JS for example the Session ID is stored as a cookie but is sent as a header by the library when making further calls to the cloud service in the same session. In the Cloud On-Premise engines the Session ID again is stored and sent along with every subsequent request to the cloud service for that session. 

Non unique evidence can be discarded. This can be achieved using a tracker that operates on the evidence that share usage will be sharing (as described above). This tracker should store a nullable DateTime that corresponds to the time that the key was first seen. The key is a hash of the evidence previously shared. When a match is found in the tracker, the evidence should only be shared if the stored DateTime is outside the defined timespan, this determines if it as new session. 

For example, flow data contains a single piece of evidence where key = ‘header.user-agent’ and value = ‘abc’. When the item is shared, this same key value pair will be used as the key to the tracker and the current date/time stored against it. 

If another flow data contains ‘header.user-agent’ = ‘efg’ then it will be a different key to the tracker and so the data will be shared. 

However, if another flow data contains ‘header.user-agent’ = ‘abc’ then it will only be shared if the current date/time is now after the date/time + the defined interval that is set when the key was first stored. 

# Error handling 

As a general principle, share usage should be considered an expendable activity. If errors occur or if the operation of share usage would compromise the rest of the system, then it should be stopped indefinitely. 

For example, the queue of data to be sent should have a limited size and if this becomes full due to either data being added to quickly or the consumer having failed, share usage should be suspended and no more data added to the queue. 

In all cases, if share usage is suspended, an error should be logged detailing the reason. 

 

 